# online-shop-management-system-for-the-computer-science-exam-

## 1. Описание задачи

Цель работы — разработка консольного приложения «Интернет‑магазин» на C++ с использованием PostgreSQL, принципов объектно‑ориентированного программирования, умных указателей и транзакционной работы с базой данных.

Реализована система интернет‑магазина с поддержкой ролей Администратор, Менеджер и Покупатель, обработкой заказов, оплатой различными способами, аудитом действий пользователей и хранением истории изменения статусов заказов.

Используемые технологии:

* C++23
* PostgreSQL
* libpqxx
* STL (алгоритмы и лямбда‑выражения)

---

## 2. Архитектура проекта

### 2.1 Классы и их взаимосвязи

* DatabaseConnection<T> — шаблонный класс для работы с PostgreSQL (подключение, запросы)
* User — базовый абстрактный класс пользователя
  * чисто виртуальные функции для работы с заказами
* Admin, Manager, Customer — наследники User
* Order — заказ пользователя
* OrderItem — элемент заказа
* Product — товар
* Payment — абстрактная стратегия оплаты
  * CardPayment, WalletPayment, SBPPayment

### 2.2 Применение ООП

* Наследование: Admin, Manager, Customer наследуют от User
* Полиморфизм: стратегии оплаты, виртуальные методы пользователя
* Композиция:
  * Order владеет OrderItem
  * Order владеет Payment через std::unique_ptr
* Агрегация:
  * User хранит std::vector<std::shared_ptr<Order>>

---

## 3. Работа с базой данных

### 3.1 Структура базы данных

Используются следующие таблицы:

* users
* products
* orders
* order_items
* order_status_history
* audit_log

Добавлены ограничения:

* CHECK (price > 0)
* CHECK (stock_quantity >= 0)
* UNIQUE (email)
* NOT NULL CHECK (role IN ('admin', 'manager', 'customer'))
* NOT NULL CHECK (entity_type IN ('order', 'product', 'user'))
* NOT NULL CHECK (operation IN ('insert', 'update', 'delete'))
* NOT NULL CHECK (status IN ('pending', 'completed', 'canceled', 'returned'))


### 3.2 Хранимые процедуры, функции и триггеры

Процедуры:

* createOrder — создание заказа с элементами и расчётом итоговой суммы 
* update_Order_status - изменение статуса заказа 
* addToOrder и deleteFromOrder - корректное добавление и удаление товаров из заказа

Функции:

* getOrderStatus(order_id) - возвращение статуса заказа по ID
* getOrderStatusHistory(order_id) - возвращение таблицы изменения статусов заказа
* getUserOrderCount(user_id) - возвращение количества заказов по статусам
* getTotalSpentByUser(user_id) - возвращение потраченной пользователем суммы
* canReturnOrder(order_id) - возвращение true/false в зависимости от соответствия условиям возврата
* getAuditLogByUser(user_id) - возвращение таблицы действий определённого пользователя
* createOrderAuditHistory - возвращение информации из трёх таблиц (orders, order_status_history, audit_log)

Триггеры:

* обновление order_date при смене статуса заказа
* аудит изменения статусов заказов

### 3.3 Транзакции

Все критические операции выполняются внутри транзакций. При ошибках происходит ROLLBACK.

---

## 4. Умные указатели и STL

### 4.1 Умные указатели

* std::unique_ptr — для Payment, DatabaseConnection, User
* std::shared_ptr — для Order, Product,

(Без использования new и delete)

### 4.2 STL и лямбда‑выражения

Используются:

* std::find_if — поиск заказов и товаров (Класс Customer, case 3)
* std::copy_if — фильтрация заказов по статусу (Класс User, метод orderFilterByStatus)
* std::accumulate — подсчёт общей суммы заказов (Класс User, метод totalAmount)
* лямбда‑функции — проверка прав доступа и фильтрация (Класс User, метод canChangeStatus)

---

## 5. Логика ролей и прав доступа

### Администратор

* управление товарами
* просмотр и изменение всех заказов
* просмотр истории статусов
* просмотр audit log
* формирование CSV‑отчёта

### Менеджер

* утверждение заказов
* обновление склада
* просмотр заказов в обработке
* доступ только к audit‑записям заказов

### Покупатель

* создание и оплата заказов
* добавление и удаление товаров
* возврат заказа (небольше 30 дней)
* доступ только к своим заказам

---

## 6. Аудит и история изменений

### Таблица order_status_history

Хранит: заказ, старый и новый статус, дату изменения, пользователя

### Таблица audit_log

Фиксирует: операции с товарами, заказами и пользователями, тип операции (insert / update / delete), пользователя, дату

Логирование выполняется автоматически через триггеры и C++‑логику.

пример:
[ID][Сущность][ID сущности][Операция][ID пользователя][Дата выполнения]
2 order 2 insert 1 2026-01-05 20:56:41.48216 
5 product 1 update 1 2026-01-09 21:00:27.117806 

---

## 7. Отчёт в формате CSV

Отчёт «История изменений заказов и действий пользователей»:

* формируется SQL‑запросом
* объединяет orders, order_status_history, audit_log
* использует агрегатные функции
* доступен только администратору

Пример фрагмента из файла:
{
 "order_id":4,
 "current_status": "canceled",
 "order_date": "2026-01-14 02:02:03.350931",
 "number_of_status_changes": 1,
 "last_action": "update",
 "action_date": "2026-01-14 02:02:03.350931",
 "number_of_audit_actions": 1
}
---

## 8. Сборка и запуск проекта

### Требования

* C++17
* PostgreSQL
* libpqxx
* CMake

### Сборка

При работе с IDE eclipse необходимо только указать пути к библиотеки libpqxx
project/properties/C/C++ Build/settings/Libraries

### Запуск

./online_store

### Пример запуска

1. Войти как Администратор
2. Войти как Менеджер
3. Войти как Покупатель
4. Выход

В зависимости от выбранной роли загружается соответствующее меню с учётом прав доступа.

=== МЕНЮ АДМИНИСТРАТОРА ===
1. Добавить новый продукт
2. Вывести список всех продуктов
3. Обновить информацию о продукте
4. Удалить продукт
5. Просмотр всех заказов
6. Просмотр деталей заказа
7. Изменить статус заказа
8. Просмотр истории статусов заказа
9. Просмотр журнала аудита
10. Сформировать отчёт
 0. Выход
Ваш выбор: 

Пример работы: 
Ваш выбор: 1

Название продукта: Колонка
Цена: 10000
Количество на складе: 235
Товар успешно добавлен (ID = 10)
Продукт добавлен с ID: 10

=== МЕНЮ МЕНЕДЖЕРА ===
1. Просмотр заказов в ожидании утверждения
2. Утвердить заказ
3. Обновить количество товара на складе
4. Просмотр деталей заказа
5. Просмотр истории утверждённых заказов
6. Просмотр истории статусов заказов
0. Выход
Ваш выбор: 

пример работ:

Ваш выбор: 3

[ID][Навание][Стоимость][Кол-во на складе]
1, Ноутбук, 75000, 14
2, Смартфон, 45000, 13
3, Наушники, 5000, 28
4, Клавиатура, 3500, 40
5, Мышь, 2000, 20
8, Плейстейшн, 70000, 100
9, Смартфон, 33000, 150
10, Колонка, 10000, 235

Введите ID продукта: 8
Введите новое количество на складе: 200
Информация о товаре с ID = 8 обновлена

=== МЕНЮ ПОКУПАТЕЛЯ ===
1. Создать новый заказ
2. Добавить товар в заказ
3. Удалить товар из заказа
4. Просмотр моих заказов
5. Просмотр статуса заказа
6. Оплатить заказ
7. Оформить возврат заказа
8. Просмотр истории статусов заказа"
0. Выход
Ваш выбор: 

пример работы:

Ваш выбор: 6

ID заказа для оплаты: 12


=== МЕНЮ ОПЛАТЫ === 
1. Оплата банковской картой
2. Оплата электронным кошельком
3. Оплата через СБП
0. Отмена
Ваш выбор: 2

ID вашего кошелька: 0Asxa2210a2ca02hziq24n
Оплата электронным кошельком
Сумма: 150000 руб.
Кошелёк: 0Asxa2210a2ca02hziq24n
Заказ оплачен на сумму: 150000

---

## 9. Структура репозитория
```
/online-shop-management-system-for-the-computer-science-exam-
|___ /online-store
|     |__ src/ # файлы .cpp
|     |__ include/ файлы .h
|     |__ sql/ #SQL-скрипты и таблицы
|     |__ reports/ #отчёт в формате CSV
|
|___ README.md
|
|___ .gitignore
```
